<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîÆ –ö—Ä–∏—à—Ç–∞–ª–µ–≤–∞ –ö—É–ª—è –ü—Ä–æ—Ä–æ—Ü—Ç–≤ AR</title>

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden; 
            width: 100vw;
            height: 100vh;
        }
        
        a-scene {
            display: block;
            width: 100%;
            height: 100%;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #8a2be2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        #instruction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            z-index: 1000;
        }

        #debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            z-index: 1000;
        }

        #marker-help {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞–≥—ñ—ó...</p>
    </div>

    <div id="instruction" class="hidden">
        üëÜ –¢–æ—Ä–∫–Ω—ñ—Ç—å—Å—è –∫—Ä–∏—à—Ç–∞–ª–µ–≤–æ—ó –∫—É–ª—ñ, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø—Ä–æ—Ä–æ—Ü—Ç–≤–æ
    </div>

    <div id="debug-info" class="hidden"></div>

    <div id="marker-help" class="hidden">
        <h3>üîç –ù–µ –±–∞—á—É –º–∞—Ä–∫–µ—Ä</h3>
        <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –ê4</p>
        <p>–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –¥–æ—Å—Ç–∞—Ç–Ω—î –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è</p>
        <button id="retry-marker">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: marker.mind; autoStart: false; maxTrack: 2;" 
        color-space="sRGB" 
        embedded 
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        id="main-scene"
    >
        
        <a-assets>
            <audio id="fon" src="assets/sounds/fon.mp3" preload="auto"></audio>
            <audio id="fon1" src="assets/sounds/fon1.mp3" preload="auto"></audio>
            <!-- –î–æ–¥–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–∏–π —à—Ä–∏—Ñ—Ç -->
            <a-mixin id="text-style" text="font: https://cdn.aframe.io/fonts/mozillavr.fnt; color: #00bfff; align: center"></a-mixin>
        </a-assets>

        <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ê –ö–ê–ú–ï–†–ê -->
        <a-entity 
            camera="active: true"
            position="0 1.6 0"
            wasd-controls="enabled: false"
            look-controls="enabled: true"
            cursor="rayOrigin: mouse"
            raycaster="objects: .clickable">
        </a-entity>

        <!-- –û–°–ù–û–í–ù–ò–ô –ú–ê–†–ö–ï–† -->
        <a-entity mindar-image-target="targetIndex: 0" id="marker-anchor">
            
            <!-- –û–°–ù–û–í–ù–ê –°–¶–ï–ù–ê –ó –ö–£–õ–ï–Æ -->
            <a-entity id="crystal-scene" position="0 0.3 0" scale="1.5 1.5 1.5">
                
                <!-- –ö–†–ò–®–¢–ê–õ–ï–í–ê –ö–£–õ–Ø -->
                <a-sphere 
                    id="crystal-ball"
                    class="clickable"
                    radius="0.25" 
                    position="0 0.25 0"
                    material="shader: custom; opacity: 0.7; refractionRatio: 0.95;"
                    cursor-listener> 
                </a-sphere>
                
                <!-- –í–ù–£–¢–†–Ü–®–ù–Ñ –°–í–Ü–¢–Ü–ù–ù–Ø -->
                <a-sphere 
                    id="inner-glow"
                    radius="0.22" 
                    position="0 0.25 0"
                    material="shader: flat; color: #4a00e0; opacity: 0.8; transparent: true"
                    inner-glow>
                </a-sphere>
                
                <!-- –ê–£–†–ê -->
                <a-ring 
                    id="aura"
                    radius-inner="0.28" 
                    radius-outer="0.4" 
                    position="0 0.25 0"
                    rotation="-90 0 0"
                    material="shader: flat; color: #8a2be2; opacity: 0.6; transparent: true"
                    aura-effect>
                </a-ring>
                
                <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ò–ô –¢–ï–ö–°–¢ - –í–ò–ö–û–†–ò–°–¢–û–í–£–Ñ–ú–û MIXIN -->
                <a-entity 
                    id="prophecy-text"
                    position="0 0.7 0"
                    mixin="text-style"
                    text="width: 3; value: ; opacity: 0; wrapCount: 30"
                    visible="false">
                </a-entity>
                
                <!-- –ü–Ü–î–°–¢–ê–í–ê -->
                <a-cylinder 
                    radius="0.35" 
                    height="0.08" 
                    position="0 -0.15 0"
                    material="color: #2c2c2c; roughness: 0.8; metalness: 0.3">
                </a-cylinder>
                
                <!-- –î–û–î–ê–¢–ö–û–í–ê –ü–Ü–î–°–¢–ê–í–ê -->
                <a-cylinder 
                    radius="0.4" 
                    height="0.03" 
                    position="0 -0.2 0"
                    material="color: #1a1a1a; roughness: 0.9">
                </a-cylinder>
                
                <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ß–ê–°–¢–ò–ù–û–ö -->
                <a-entity id="particles-container" position="0 0.25 0"></a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        // –°–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è –±–µ–∑ —Å–∫–ª–∞–¥–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
        AFRAME.registerShader('custom', {
            schema: {
                time: {type: 'time', is: 'uniform', default: 0},
                opacity: {type: 'number', is: 'uniform', default: 0.7},
                refractionRatio: {type: 'number', is: 'uniform', default: 0.95}
            },
            
            vertexShader: `
                varying vec3 vNormal;
                varying vec3 vPosition;
                
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    vPosition = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            
            fragmentShader: `
                varying vec3 vNormal;
                varying vec3 vPosition;
                uniform float time;
                uniform float opacity;
                uniform float refractionRatio;
                
                void main() {
                    vec3 normal = normalize(vNormal);
                    float intensity = pow(0.7 - dot(normal, vec3(0.0, 0.0, 1.0)), 4.0);
                    
                    vec3 baseColor = vec3(0.3, 0.1, 0.8);
                    vec3 pulseColor = baseColor * (0.8 + 0.2 * sin(time * 0.005)); 
                    
                    vec3 refracted = refract(vec3(0.0, 0.0, 1.0), normal, refractionRatio);
                    float refractionEffect = dot(refracted, refracted);
                    
                    vec3 finalColor = mix(pulseColor, vec3(1.0), intensity * 0.3);
                    finalColor += refractionEffect * 0.1;
                    
                    gl_FragColor = vec4(finalColor, opacity * (0.7 + 0.3 * intensity));
                }
            `
        });

        // –ö–û–ú–ü–û–ù–ï–ù–¢–ò –ê–ù–Ü–ú–ê–¶–Ü–á
        AFRAME.registerComponent('inner-glow', {
            init: function() {
                this.el.setAttribute('animation', {
                    property: 'components.material.material.opacity',
                    to: '0.9',
                    dir: 'alternate',
                    dur: 2000,
                    loop: true,
                    easing: 'easeInOutSine'
                });
            }
        });

        AFRAME.registerComponent('aura-effect', {
            init: function() {
                this.el.setAttribute('animation', {
                    property: 'scale',
                    to: '1.3 1.3 1.3',
                    dir: 'alternate',
                    dur: 3000,
                    loop: true,
                    easing: 'easeInOutSine'
                });
            }
        });

        // –°–ò–°–¢–ï–ú–ê –ß–ê–°–¢–ò–ù–û–ö
        AFRAME.registerComponent('particle-system', {
            init: function() {
                this.particles = [];
                this.active = false;
            },
            
            activate: function() {
                if (this.active) return;
                this.active = true;
                
                const container = this.el;
                const particleCount = 40;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('a-sphere');
                    const size = 0.015 + Math.random() * 0.02;
                    particle.setAttribute('radius', size);
                    particle.setAttribute('color', i % 2 === 0 ? '#8a2be2' : '#00bfff');
                    particle.setAttribute('position', '0 0 0');
                    particle.setAttribute('opacity', '1');
                    
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 0.5 + Math.random() * 0.5;
                    const targetX = Math.cos(angle) * speed;
                    const targetY = Math.random() * 0.5;
                    const targetZ = Math.sin(angle) * speed;
                    
                    const duration = 800 + Math.random() * 800;
                    
                    particle.setAttribute('animation', {
                        property: 'position',
                        to: `${targetX} ${targetY} ${targetZ}`,
                        dur: duration,
                        easing: 'easeOutQuad'
                    });
                    
                    particle.setAttribute('animation__opacity', {
                        property: 'components.material.material.opacity',
                        to: '0',
                        dur: duration,
                        easing: 'easeOutQuad'
                    });
                    
                    particle.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0.1 0.1 0.1',
                        dur: duration,
                        easing: 'easeOutQuad'
                    });
                    
                    container.appendChild(particle);
                    this.particles.push(particle);
                }
                
                setTimeout(() => {
                    this.particles.forEach(particle => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    });
                    this.particles = [];
                    this.active = false;
                }, 2500);
            }
        });
        
        // –ö–û–ú–ü–û–ù–ï–ù–¢ –î–õ–Ø –¢–ï–ö–°–¢–£
        AFRAME.registerComponent('text-reveal', {
            schema: {
                text: {type: 'string', default: ''},
                speed: {type: 'number', default: 35}
            },
            
            init: function() {
                this.revealing = false;
                this.currentText = '';
                this.charIndex = 0;
                this.timeout = null;
            },
            
            startReveal: function(text) {
                if (this.revealing) {
                    clearTimeout(this.timeout);
                    return;
                }
                
                this.revealing = true;
                this.currentText = text;
                this.charIndex = 0;
                this.el.setAttribute('visible', true);
                this.el.setAttribute('text', 'value', '');
                this.el.setAttribute('text', 'opacity', 1);
                
                this.revealNextChar();
            },
            
            revealNextChar: function() {
                if (this.charIndex >= this.currentText.length) {
                    this.revealing = false;
                    this.addColorAnimation();
                    return;
                }
                
                const currentValue = this.el.getAttribute('text').value || '';
                const newValue = currentValue + this.currentText[this.charIndex];
                this.el.setAttribute('text', 'value', newValue);
                
                this.charIndex++;
                this.timeout = setTimeout(() => this.revealNextChar(), this.data.speed);
            },
            
            addColorAnimation: function() {
                this.el.setAttribute('animation', {
                    property: 'text.color',
                    from: '#8a2be2',
                    to: '#00bfff',
                    dir: 'alternate',
                    dur: 2000,
                    loop: true
                });
            }
        });

        // –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            const loadingScreen = document.getElementById('loading-screen');
            const instruction = document.getElementById('instruction');
            const debugInfo = document.getElementById('debug-info');
            const markerHelp = document.getElementById('marker-help');
            const retryButton = document.getElementById('retry-marker');
            
            const crystalBall = document.getElementById('crystal-ball');
            const innerGlow = document.getElementById('inner-glow');
            const prophecyText = document.getElementById('prophecy-text');
            const particlesContainer = document.getElementById('particles-container');
            const aura = document.getElementById('aura');
            
            const backgroundSound = document.getElementById('fon');
            const magicSound = document.getElementById('fon1');
            
            let systemReady = false;
            let prophecyActive = false;
            let markerVisible = false;
            let markerTimeout = null;
            
            const prophecies = [
                "–®–ª—è—Ö –¥–æ –£—Å–ø—ñ—Ö—É –ª–µ–∂–∏—Ç—å —á–µ—Ä–µ–∑ –∑–Ω–∞–Ω–Ω—è —Ç–∞ –ù–∞–ø–æ–ª–µ–≥–ª–∏–≤—ñ—Å—Ç—å",
                "–ù–æ–≤—ñ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥–∫—Ä–∏—é—Ç—å—Å—è –ø–µ—Ä–µ–¥ –≤–∞–º–∏ –¥—É–∂–µ —Å–∫–æ—Ä–æ",
                "–î–æ–≤—ñ—Ä—è–π—Ç–µ —Å–≤–æ—ó–π –Ü–Ω—Ç—É—ó—Ü—ñ—ó - –≤–æ–Ω–∞ –ø—Ä–∏–≤–µ–¥–µ –≤–∞—Å –¥–æ –º–µ—Ç–∏",
                "–ó—É—Å—Ç—Ä—ñ—á –∑ –≤–∞–∂–ª–∏–≤–æ—é –ª—é–¥–∏–Ω–æ—é –ó–º—ñ–Ω–∏—Ç—å –≤–∞—à–µ –∂–∏—Ç—Ç—è",
                "–í–∞—à–∞ –¢–≤–æ—Ä—á—ñ—Å—Ç—å –ø—Ä–∏–Ω–µ—Å–µ –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω—ñ –ø–ª–æ–¥–∏",
                "–ü–æ–¥–æ—Ä–æ–∂ –≤—ñ–¥–∫—Ä–∏—î –ù–æ–≤—ñ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∏ –¥–ª—è —Ä–æ–∑–≤–∏—Ç–∫—É",
                "–í—ñ—Ä–∞ –≤ —Å–µ–±–µ - –ö–ª—é—á –¥–æ –ø–æ–¥–æ–ª–∞–Ω–Ω—è –±—É–¥—å-—è–∫–∏—Ö –ø–µ—Ä–µ—à–∫–æ–¥"
            ];
            
            // –í–Ü–î–°–¢–ï–ñ–ï–ù–ù–Ø –ú–ê–†–ö–ï–†–ê
            scene.addEventListener('targetFound', event => {
                console.log('–ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!');
                markerVisible = true;
                clearTimeout(markerTimeout);
                markerHelp.classList.add('hidden');
                
                if (!prophecyActive) {
                    instruction.classList.remove('hidden');
                }
                
                debugInfo.textContent = '–ú–∞—Ä–∫–µ—Ä: –∑–Ω–∞–π–¥–µ–Ω–æ';
            });
            
            scene.addEventListener('targetLost', event => {
                console.log('–ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ!');
                markerVisible = false;
                instruction.classList.add('hidden');
                
                markerTimeout = setTimeout(() => {
                    if (!markerVisible) {
                        markerHelp.classList.remove('hidden');
                    }
                }, 15000);
                
                debugInfo.textContent = '–ú–∞—Ä–∫–µ—Ä: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
            });
            
            scene.addEventListener('loaded', function() {
                const mindarSystem = scene.systems["mindar-image-system"];
                
                const startExperience = () => {
                    mindarSystem.start(); 
                    console.log('MindAR system started');
                    
                    backgroundSound.volume = 0.3;
                    backgroundSound.loop = true;
                    backgroundSound.play().catch(e => console.log('Auto-play blocked'));
                    
                    loadingScreen.classList.add('hidden');
                    debugInfo.classList.remove('hidden');
                    systemReady = true;
                    
                    document.body.removeEventListener('click', startExperience);
                    document.body.removeEventListener('touchstart', startExperience);
                };
                
                document.body.addEventListener('click', startExperience);
                document.body.addEventListener('touchstart', startExperience);
            });
            
            // –û–ë–†–û–ë–ù–ò–ö –ö–õ–Ü–ö–£
            crystalBall.addEventListener('click', function(event) {
                event.stopPropagation();
                if (!systemReady || !markerVisible || prophecyActive) return;
                startProphecy();
            });
            
            function startProphecy() {
                prophecyActive = true;
                instruction.classList.add('hidden');
                
                const randomProphecy = prophecies[Math.floor(Math.random() * prophecies.length)];
                
                // –ê–ù–Ü–ú–ê–¶–Ü–á
                crystalBall.setAttribute('animation', {
                    property: 'components.material.material.uniforms.time.value',
                    to: 5000,
                    dur: 1000,
                    easing: 'easeInQuad'
                });
                
                innerGlow.setAttribute('animation', {
                    property: 'components.material.material.opacity',
                    to: 1.0,
                    dur: 1000,
                    easing: 'easeInQuad'
                });
                
                setTimeout(() => {
                    aura.setAttribute('material', 'opacity', 0.8);
                    aura.setAttribute('animation', {
                        property: 'scale',
                        to: '1.5 1.5 1.5',
                        dur: 300,
                        easing: 'easeOutQuad'
                    });
                    
                    particlesContainer.components['particle-system'].activate();
                    
                    magicSound.currentTime = 0;
                    magicSound.volume = 0.7;
                    magicSound.play();
                    
                    setTimeout(() => {
                        prophecyText.components['text-reveal'].startReveal(randomProphecy);
                        
                        setTimeout(() => {
                            crystalBall.setAttribute('animation', {
                                property: 'components.material.material.uniforms.time.value',
                                to: 20000,
                                dur: 3000,
                                easing: 'easeOutQuad'
                            });
                            
                            innerGlow.setAttribute('animation', {
                                property: 'components.material.material.opacity',
                                to: 0.8,
                                dur: 3000,
                                easing: 'easeOutQuad'
                            });
                            
                            aura.setAttribute('material', 'opacity', 0.6);
                            aura.setAttribute('scale', '1 1 1');
                            
                            setTimeout(() => {
                                prophecyActive = false;
                                if (markerVisible) {
                                    instruction.classList.remove('hidden');
                                    instruction.textContent = 'üëÜ –¢–æ—Ä–∫–Ω—ñ—Ç—å—Å—è –∑–Ω–æ–≤—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ä–æ—Ü—Ç–≤–∞';
                                }
                            }, 5000);
                            
                        }, 3000);
                    }, 500);
                }, 1000);
            }

            retryButton.addEventListener('click', function() {
                markerHelp.classList.add('hidden');
            });

            // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ö–û–ú–ü–û–ù–ï–ù–¢–Ü–í
            particlesContainer.setAttribute('particle-system', '');
            prophecyText.setAttribute('text-reveal', '');
        });
    </script>
</body>
</html>
