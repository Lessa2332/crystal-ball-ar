<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîÆ –ö—Ä–∏—à—Ç–∞–ª–µ–≤–∞ –ö—É–ª—è –ü—Ä–æ—Ä–æ—Ü—Ç–≤ AR</title>

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden; 
            width: 100vw;
            height: 100vh;
        }
        
        a-scene {
            display: block;
            width: 100%;
            height: 100%;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #8a2be2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        #instruction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            z-index: 1000;
        }

        #debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            z-index: 1000;
        }

        #marker-help {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞–≥—ñ—ó...</p>
    </div>

    <div id="instruction" class="hidden">
        üëÜ –¢–æ—Ä–∫–Ω—ñ—Ç—å—Å—è –∫—Ä–∏—à—Ç–∞–ª–µ–≤–æ—ó –∫—É–ª—ñ, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø—Ä–æ—Ä–æ—Ü—Ç–≤–æ
    </div>

    <div id="debug-info" class="hidden"></div>

    <div id="marker-help" class="hidden">
        <h3>üîç –ù–µ –±–∞—á—É –º–∞—Ä–∫–µ—Ä</h3>
        <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –ê4</p>
        <p>–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –¥–æ—Å—Ç–∞—Ç–Ω—î –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è</p>
        <button id="retry-marker">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: marker.mind; autoStart: false; maxTrack: 2; filterMinCF: 0.0005; filterBeta: 0.01; warmupTolerance: 5" 
        color-space="sRGB" 
        embedded 
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        id="main-scene"
    >
        
        <a-assets>
            <audio id="fon" src="assets/sounds/fon.mp3" preload="auto"></audio>
            <audio id="fon1" src="assets/sounds/fon1.mp3" preload="auto"></audio>
        </a-assets>

        <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ê –ö–ê–ú–ï–†–ê -->
        <a-entity 
            camera="active: true"
            position="0 1.6 0"
            wasd-controls="enabled: false"
            look-controls="enabled: true"
            cursor="rayOrigin: mouse"
            raycaster="objects: .clickable">
        </a-entity>

        <!-- –û–°–ù–û–í–ù–ò–ô –ú–ê–†–ö–ï–† -->
        <a-entity mindar-image-target="targetIndex: 0" id="marker-anchor">
            
            <!-- –û–°–ù–û–í–ù–ê –°–¶–ï–ù–ê –ó –ö–£–õ–ï–Æ -->
            <a-entity id="crystal-scene" position="0 0.3 0" scale="1.5 1.5 1.5">
                
                <!-- –ö–†–ò–®–¢–ê–õ–ï–í–ê –ö–£–õ–Ø –ó –ü–û–õ–Ü–ü–®–ï–ù–ò–ú –®–ï–ô–î–ï–†–û–ú -->
                <a-sphere 
                    id="crystal-ball"
                    class="clickable"
                    radius="0.25" 
                    position="0 0.25 0"
                    material="shader: enhanced-crystal; opacity: 0.7; baseColor: #4a00e0; refractionRatio: 0.95;"
                    cursor-listener> 
                </a-sphere>
                
                <!-- –í–ù–£–¢–†–Ü–®–ù–Ñ –°–í–Ü–¢–Ü–ù–ù–Ø -->
                <a-sphere 
                    id="inner-glow"
                    radius="0.22" 
                    position="0 0.25 0"
                    material="shader: flat; color: #4a00e0; opacity: 0.8; transparent: true"
                    inner-glow>
                </a-sphere>
                
                <!-- –ê–£–†–ê -->
                <a-ring 
                    id="aura"
                    radius-inner="0.28" 
                    radius-outer="0.4" 
                    position="0 0.25 0"
                    rotation="-90 0 0"
                    material="shader: flat; color: #8a2be2; opacity: 0.6; transparent: true"
                    aura-effect>
                </a-ring>
                
                <!-- –¢–ï–ö–°–¢ –ü–†–û–†–û–¶–¢–í–ê -->
                <a-entity 
                    id="prophecy-text"
                    position="0 0.7 0"
                    text="align: center; width: 3; color: #00bfff; value: ; opacity: 0; font: arial; wrapCount: 30"
                    visible="false">
                </a-entity>
                
                <!-- –ü–Ü–î–°–¢–ê–í–ê -->
                <a-cylinder 
                    radius="0.35" 
                    height="0.08" 
                    position="0 -0.15 0"
                    material="color: #2c2c2c; roughness: 0.8; metalness: 0.3">
                </a-cylinder>
                
                <!-- –î–û–î–ê–¢–ö–û–í–ê –ü–Ü–î–°–¢–ê–í–ê -->
                <a-cylinder 
                    radius="0.4" 
                    height="0.03" 
                    position="0 -0.2 0"
                    material="color: #1a1a1a; roughness: 0.9">
                </a-cylinder>
                
                <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ß–ê–°–¢–ò–ù–û–ö -->
                <a-entity id="particles-container" position="0 0.25 0"></a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        // =============================================================================
        // –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø (Tech Lead —Ä—ñ–≤–µ–Ω—å)
        // =============================================================================
        const CONFIG = {
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è AR
            ar: {
                filterMinCF: 0.0005,
                filterBeta: 0.01,
                warmupTolerance: 5,
                markerTimeout: 15000 // 15 —Å–µ–∫—É–Ω–¥ –ø–æ—à—É–∫—É –º–∞—Ä–∫–µ—Ä–∞
            },
            
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫—É–ª—ñ
            crystal: {
                radius: 0.25,
                baseColor: '#4a00e0',
                opacity: 0.7,
                refractionRange: [0.92, 0.98] // –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Ä–µ—Ñ—Ä–∞–∫—Ü—ñ—è
            },
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—ó
            animations: {
                chargeDuration: 1000,
                explosionDelay: 1000,
                textRevealDelay: 500,
                cooldownDuration: 3000,
                finalCooldown: 5000
            },
            
            // –õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è
            i18n: {
                uk: {
                    loading: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞–≥—ñ—ó...",
                    instruction: "üëÜ –¢–æ—Ä–∫–Ω—ñ—Ç—å—Å—è –∫—Ä–∏—à—Ç–∞–ª–µ–≤–æ—ó –∫—É–ª—ñ, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø—Ä–æ—Ä–æ—Ü—Ç–≤–æ",
                    markerNotFound: "üîç –ù–µ –±–∞—á—É –º–∞—Ä–∫–µ—Ä",
                    markerHelp: "–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –ê4\n–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –¥–æ—Å—Ç–∞—Ç–Ω—î –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è",
                    retry: "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É",
                    prophecies: [
                        "–®–ª—è—Ö –¥–æ –£—Å–ø—ñ—Ö—É –ª–µ–∂–∏—Ç—å —á–µ—Ä–µ–∑ –∑–Ω–∞–Ω–Ω—è —Ç–∞ –ù–∞–ø–æ–ª–µ–≥–ª–∏–≤—ñ—Å—Ç—å",
                        "–ù–æ–≤—ñ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥–∫—Ä–∏—é—Ç—å—Å—è –ø–µ—Ä–µ–¥ –≤–∞–º–∏ –¥—É–∂–µ —Å–∫–æ—Ä–æ",
                        "–î–æ–≤—ñ—Ä—è–π—Ç–µ —Å–≤–æ—ó–π –Ü–Ω—Ç—É—ó—Ü—ñ—ó - –≤–æ–Ω–∞ –ø—Ä–∏–≤–µ–¥–µ –≤–∞—Å –¥–æ –º–µ—Ç–∏",
                        "–ó—É—Å—Ç—Ä—ñ—á –∑ –≤–∞–∂–ª–∏–≤–æ—é –ª—é–¥–∏–Ω–æ—é –ó–º—ñ–Ω–∏—Ç—å –≤–∞—à–µ –∂–∏—Ç—Ç—è",
                        "–í–∞—à–∞ –¢–≤–æ—Ä—á—ñ—Å—Ç—å –ø—Ä–∏–Ω–µ—Å–µ –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω—ñ –ø–ª–æ–¥–∏",
                        "–ü–æ–¥–æ—Ä–æ–∂ –≤—ñ–¥–∫—Ä–∏—î –ù–æ–≤—ñ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∏ –¥–ª—è —Ä–æ–∑–≤–∏—Ç–∫—É",
                        "–í—ñ—Ä–∞ –≤ —Å–µ–±–µ - –ö–ª—é—á –¥–æ –ø–æ–¥–æ–ª–∞–Ω–Ω—è –±—É–¥—å-—è–∫–∏—Ö –ø–µ—Ä–µ—à–∫–æ–¥"
                    ]
                },
                en: {
                    loading: "Loading magic...",
                    instruction: "üëÜ Touch the crystal ball to see the prophecy",
                    markerNotFound: "üîç Marker not found",
                    markerHelp: "Point camera at A4 marker\nMake sure there is enough light",
                    retry: "Try again",
                    prophecies: [
                        "The path to Success lies through Knowledge and Perseverance",
                        "New Opportunities will open up for you very soon",
                        "Trust your Intuition - it will lead you to your goal",
                        "Meeting an important person will Change your life",
                        "Your Creativity will bring unexpected fruits",
                        "Travel will open New Horizons for development",
                        "Belief in yourself is the Key to overcoming any obstacles"
                    ]
                }
            }
        };

        // =============================================================================
        // STATE MACHINE (Finite State Machine)
        // =============================================================================
        const STATE = {
            IDLE: 0,
            CHARGING: 1, 
            REVEALING: 2,
            COOLDOWN: 3,
            ERROR: 4
        };

        // =============================================================================
        // –ü–û–õ–Ü–ü–®–ï–ù–ò–ô –®–ï–ô–î–ï–† –ö–†–ò–°–¢–ê–õ–ê
        // =============================================================================
        AFRAME.registerShader('enhanced-crystal', {
            schema: {
                time: {type: 'time', is: 'uniform', default: 0},
                opacity: {type: 'number', is: 'uniform', default: CONFIG.crystal.opacity},
                refractionRatio: {type: 'number', is: 'uniform', default: 0.95},
                baseColor: {type: 'color', is: 'uniform', default: CONFIG.crystal.baseColor}
            },
            
            vertexShader: `
                varying vec3 vNormal;
                varying vec3 vPosition;
                
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    vPosition = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            
            fragmentShader: `
                varying vec3 vNormal;
                varying vec3 vPosition;
                uniform float time;
                uniform float opacity;
                uniform float refractionRatio;
                uniform vec3 baseColor;
                
                void main() {
                    vec3 normal = normalize(vNormal);
                    float intensity = pow(0.7 - dot(normal, vec3(0.0, 0.0, 1.0)), 4.0);
                    
                    // –ü—É–ª—å—Å–∞—Ü—ñ—è –∫–æ–ª—å–æ—Ä—É –∑ –±–∞–∑–æ–≤–∏–º –∫–æ–ª—å–æ—Ä–æ–º –∑ –∫–æ–Ω—Ñ—ñ–≥—É
                    vec3 pulseColor = baseColor * (0.8 + 0.2 * sin(time * 0.005)); 
                    
                    // –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Ä–µ—Ñ—Ä–∞–∫—Ü—ñ—è
                    float dynamicRefraction = refractionRatio + 0.03 * sin(time * 0.002);
                    vec3 refracted = refract(vec3(0.0, 0.0, 1.0), normal, dynamicRefraction);
                    float refractionEffect = dot(refracted, refracted);
                    
                    vec3 finalColor = mix(pulseColor, vec3(1.0), intensity * 0.3);
                    finalColor += refractionEffect * 0.1;
                    
                    gl_FragColor = vec4(finalColor, opacity * (0.7 + 0.3 * intensity));
                }
            `
        });

        // =============================================================================
        // –ö–û–ú–ü–û–ù–ï–ù–¢–ò –ê–ù–Ü–ú–ê–¶–Ü–á
        // =============================================================================
        AFRAME.registerComponent('inner-glow', {
            init: function() {
                this.el.setAttribute('animation', {
                    property: 'components.material.material.opacity',
                    to: '0.9',
                    dir: 'alternate',
                    dur: 2000,
                    loop: true,
                    easing: 'easeInOutSine'
                });
            }
        });

        AFRAME.registerComponent('aura-effect', {
            init: function() {
                this.el.setAttribute('animation', {
                    property: 'scale',
                    to: '1.3 1.3 1.3',
                    dir: 'alternate',
                    dur: 3000,
                    loop: true,
                    easing: 'easeInOutSine'
                });
            }
        });

        // =============================================================================
        // –°–ò–°–¢–ï–ú–ê –ß–ê–°–¢–ò–ù–û–ö
        // =============================================================================
        AFRAME.registerComponent('particle-system', {
            init: function() {
                this.particles = [];
                this.active = false;
            },
            
            activate: function() {
                if (this.active) return;
                this.active = true;
                
                const container = this.el;
                const particleCount = 40;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('a-sphere');
                    const size = 0.015 + Math.random() * 0.02;
                    particle.setAttribute('radius', size);
                    particle.setAttribute('color', i % 2 === 0 ? '#8a2be2' : '#00bfff');
                    particle.setAttribute('position', '0 0 0');
                    particle.setAttribute('opacity', '1');
                    
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 0.5 + Math.random() * 0.5;
                    const targetX = Math.cos(angle) * speed;
                    const targetY = Math.random() * 0.5;
                    const targetZ = Math.sin(angle) * speed;
                    
                    const duration = 800 + Math.random() * 800;
                    
                    particle.setAttribute('animation', {
                        property: 'position',
                        to: `${targetX} ${targetY} ${targetZ}`,
                        dur: duration,
                        easing: 'easeOutQuad'
                    });
                    
                    particle.setAttribute('animation__opacity', {
                        property: 'components.material.material.opacity',
                        to: '0',
                        dur: duration,
                        easing: 'easeOutQuad'
                    });
                    
                    particle.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0.1 0.1 0.1',
                        dur: duration,
                        easing: 'easeOutQuad'
                    });
                    
                    container.appendChild(particle);
                    this.particles.push(particle);
                }
                
                setTimeout(() => {
                    this.particles.forEach(particle => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    });
                    this.particles = [];
                    this.active = false;
                }, 2500);
            }
        });

        // =============================================================================
        // –ö–û–ú–ü–û–ù–ï–ù–¢ –î–õ–Ø –¢–ï–ö–°–¢–£ –ó ASYNC/AWAIT
        // =============================================================================
        AFRAME.registerComponent('text-reveal', {
            schema: {
                text: {type: 'string', default: ''},
                speed: {type: 'number', default: 35}
            },
            
            init: function() {
                this.revealing = false;
                this.currentText = '';
                this.charIndex = 0;
            },
            
            async startReveal(text) {
                if (this.revealing) return;
                
                this.revealing = true;
                this.currentText = text;
                this.charIndex = 0;
                this.el.setAttribute('visible', true);
                this.el.setAttribute('text', 'value', '');
                this.el.setAttribute('text', 'opacity', 1);
                
                await this.revealText();
                await this.addColorAnimation();
                
                this.revealing = false;
            },
            
            revealText() {
                return new Promise((resolve) => {
                    const revealNextChar = () => {
                        if (this.charIndex >= this.currentText.length) {
                            resolve();
                            return;
                        }
                        
                        const currentValue = this.el.getAttribute('text').value || '';
                        const newValue = currentValue + this.currentText[this.charIndex];
                        this.el.setAttribute('text', 'value', newValue);
                        
                        this.charIndex++;
                        setTimeout(revealNextChar, this.data.speed);
                    };
                    
                    revealNextChar();
                });
            },
            
            addColorAnimation() {
                return new Promise((resolve) => {
                    this.el.setAttribute('animation', {
                        property: 'text.color',
                        from: '#8a2be2',
                        to: '#00bfff',
                        dir: 'alternate',
                        dur: 2000,
                        loop: true
                    });
                    setTimeout(resolve, 100);
                });
            }
        });

        // =============================================================================
        // –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê –ó STATE MANAGEMENT
        // =============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
            const scene = document.querySelector('a-scene');
            const loadingScreen = document.getElementById('loading-screen');
            const instruction = document.getElementById('instruction');
            const debugInfo = document.getElementById('debug-info');
            const markerHelp = document.getElementById('marker-help');
            const retryButton = document.getElementById('retry-marker');
            
            const crystalBall = document.getElementById('crystal-ball');
            const innerGlow = document.getElementById('inner-glow');
            const prophecyText = document.getElementById('prophecy-text');
            const particlesContainer = document.getElementById('particles-container');
            const aura = document.getElementById('aura');
            
            const backgroundSound = document.getElementById('fon');
            const magicSound = document.getElementById('fon1');
            
            // –°—Ç–∞–Ω –ø—Ä–æ–≥—Ä–∞–º–∏
            let currentState = STATE.IDLE;
            let systemReady = false;
            let markerVisible = false;
            let markerTimeout = null;
            let currentLanguage = 'uk';
            let prophecies = CONFIG.i18n.uk.prophecies;

            // =========================================================================
            // –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á (Async/Await –∑–∞–º—ñ—Å—Ç—å setTimeout)
            // =========================================================================
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            const setState = (newState) => {
                console.log(`State change: ${currentState} -> ${newState}`);
                currentState = newState;
            };

            const trackEvent = (eventName, eventData = {}) => {
                // –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –¥–ª—è Tech Lead
                console.log('üìä Analytics Event:', eventName, eventData);
                
                // Google Analytics (—è–∫—â–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ)
                if (typeof gtag !== 'undefined') {
                    gtag('event', eventName, eventData);
                }
            };

            // =========================================================================
            // –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê –ü–†–û–†–û–¶–¢–í–ê (Async/Await)
            // =========================================================================
            async function startProphecy() {
                if (currentState !== STATE.IDLE || !markerVisible) return;
                
                setState(STATE.CHARGING);
                trackEvent('prophecy_started');
                
                instruction.classList.add('hidden');
                const randomProphecy = prophecies[Math.floor(Math.random() * prophecies.length)];
                
                try {
                    // –§–∞–∑–∞ –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è
                    await chargePhase();
                    
                    // –§–∞–∑–∞ –≤–∏–±—É—Ö—É
                    await explosionPhase();
                    
                    // –§–∞–∑–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø—Ä–æ—Ä–æ—Ü—Ç–≤–∞
                    await revelationPhase(randomProphecy);
                    
                    // –§–∞–∑–∞ –æ—Å—Ç–∏–≥–∞–Ω–Ω—è
                    await cooldownPhase();
                    
                } catch (error) {
                    console.error('Prophecy error:', error);
                    setState(STATE.ERROR);
                }
            }

            async function chargePhase() {
                crystalBall.setAttribute('animation', {
                    property: 'components.material.material.uniforms.time.value',
                    to: 5000,
                    dur: CONFIG.animations.chargeDuration,
                    easing: 'easeInQuad'
                });
                
                innerGlow.setAttribute('animation', {
                    property: 'components.material.material.opacity',
                    to: 1.0,
                    dur: CONFIG.animations.chargeDuration,
                    easing: 'easeInQuad'
                });
                
                await delay(CONFIG.animations.chargeDuration);
            }

            async function explosionPhase() {
                aura.setAttribute('material', 'opacity', 0.8);
                aura.setAttribute('animation', {
                    property: 'scale',
                    to: '1.5 1.5 1.5',
                    dur: 300,
                    easing: 'easeOutQuad'
                });
                
                particlesContainer.components['particle-system'].activate();
                
                magicSound.currentTime = 0;
                magicSound.volume = 0.7;
                magicSound.play();
                
                setState(STATE.REVEALING);
                await delay(CONFIG.animations.explosionDelay);
            }

            async function revelationPhase(prophecyTextContent) {
                await prophecyText.components['text-reveal'].startReveal(prophecyTextContent);
                trackEvent('prophecy_revealed', { text: prophecyTextContent });
                await delay(CONFIG.animations.textRevealDelay);
            }

            async function cooldownPhase() {
                setState(STATE.COOLDOWN);
                
                crystalBall.setAttribute('animation', {
                    property: 'components.material.material.uniforms.time.value',
                    to: 20000,
                    dur: CONFIG.animations.cooldownDuration,
                    easing: 'easeOutQuad'
                });
                
                innerGlow.setAttribute('animation', {
                    property: 'components.material.material.opacity',
                    to: 0.8,
                    dur: CONFIG.animations.cooldownDuration,
                    easing: 'easeOutQuad'
                });
                
                aura.setAttribute('material', 'opacity', 0.6);
                aura.setAttribute('scale', '1 1 1');
                
                await delay(CONFIG.animations.cooldownDuration);
                await delay(CONFIG.animations.finalCooldown);
                
                setState(STATE.IDLE);
                if (markerVisible) {
                    instruction.classList.remove('hidden');
                    instruction.textContent = CONFIG.i18n[currentLanguage].instruction;
                }
                
                trackEvent('prophecy_completed');
            }

            // =========================================================================
            // MARKER MANAGEMENT –¢–ê FALLBACK
            // =========================================================================
            function startMarkerTimeout() {
                clearMarkerTimeout();
                markerTimeout = setTimeout(() => {
                    if (!markerVisible) {
                        markerHelp.classList.remove('hidden');
                        trackEvent('marker_timeout');
                    }
                }, CONFIG.ar.markerTimeout);
            }

            function clearMarkerTimeout() {
                if (markerTimeout) {
                    clearTimeout(markerTimeout);
                    markerTimeout = null;
                }
            }

            // =========================================================================
            // EVENT HANDLERS
            // =========================================================================
            scene.addEventListener('targetFound', event => {
                console.log('–ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!');
                markerVisible = true;
                clearMarkerTimeout();
                markerHelp.classList.add('hidden');
                
                if (currentState === STATE.IDLE) {
                    instruction.classList.remove('hidden');
                }
                
                debugInfo.textContent = `–ú–∞—Ä–∫–µ—Ä: –∑–Ω–∞–π–¥–µ–Ω–æ | –°—Ç–∞–Ω: ${currentState}`;
                trackEvent('marker_found');
            });
            
            scene.addEventListener('targetLost', event => {
                console.log('–ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ!');
                markerVisible = false;
                instruction.classList.add('hidden');
                startMarkerTimeout();
                
                debugInfo.textContent = `–ú–∞—Ä–∫–µ—Ä: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ | –°—Ç–∞–Ω: ${currentState}`;
                trackEvent('marker_lost');
            });
            
            scene.addEventListener('loaded', function() {
                const mindarSystem = scene.systems["mindar-image-system"];
                
                const startExperience = () => {
                    mindarSystem.start(); 
                    console.log('MindAR system started with enhanced tracking');
                    
                    backgroundSound.volume = 0.3;
                    backgroundSound.loop = true;
                    backgroundSound.play().catch(e => console.log('Auto-play blocked'));
                    
                    loadingScreen.classList.add('hidden');
                    debugInfo.classList.remove('hidden');
                    systemReady = true;
                    
                    startMarkerTimeout();
                    trackEvent('experience_started');
                    
                    document.body.removeEventListener('click', startExperience);
                    document.body.removeEventListener('touchstart', startExperience);
                };
                
                document.body.addEventListener('click', startExperience);
                document.body.addEventListener('touchstart', startExperience);
            });
            
            crystalBall.addEventListener('click', function(event) {
                event.stopPropagation();
                if (currentState === STATE.IDLE && markerVisible && systemReady) {
                    startProphecy();
                }
            });
            
            retryButton.addEventListener('click', function() {
                markerHelp.classList.add('hidden');
                startMarkerTimeout();
                trackEvent('marker_retry');
            });

            // =========================================================================
            // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
            // =========================================================================
            particlesContainer.setAttribute('particle-system', '');
            prophecyText.setAttribute('text-reveal', '');
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—ñ–≤ –∑ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó
            loadingScreen.querySelector('p').textContent = CONFIG.i18n[currentLanguage].loading;
            instruction.textContent = CONFIG.i18n[currentLanguage].instruction;
            markerHelp.querySelector('h3').textContent = CONFIG.i18n[currentLanguage].markerNotFound;
            markerHelp.querySelector('p').textContent = CONFIG.i18n[currentLanguage].markerHelp;
            retryButton.textContent = CONFIG.i18n[currentLanguage].retry;
        });
    </script>
</body>
</html>
